{% extends "base.html" %}
{% block title %}Transactions{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Transactions for {{ current_user.name }} ({{ current_user.username }})</h2>

  <!-- Filter Form -->
  <form method="GET" class="filter-form mb-4">
    <label for="name">Search by Name:</label>
    <input type="text" name="name" id="name" placeholder="Beneficiary Name" value="{{ request.args.get('name', '') }}">

    <label for="start_date">Start Date:</label>
    <input type="date" name="start_date" id="start_date" value="{{ request.args.get('start_date', '') }}">

    <label for="end_date">End Date:</label>
    <input type="date" name="end_date" id="end_date" value="{{ request.args.get('end_date', '') }}">

    <label for="transaction_type">Transaction Type:</label>
    <select name="transaction_type" id="transaction_type">
      <option value="">All</option>
      <option value="deposit" {% if request.args.get('transaction_type') == 'deposit' %}selected{% endif %}>Deposit</option>
      <option value="withdraw" {% if request.args.get('transaction_type') == 'withdraw' %}selected{% endif %}>Withdraw</option>
    </select>

    <button type="submit" class="btn btn-primary btn-sm">Filter</button>
    <a href="{{ url_for('main.transactions') }}" class="btn btn-secondary btn-sm">Reset</a>
  </form>

  {% if transactions %}
  <table class="table table-striped table-bordered">
    <thead class="table-primary">
      <tr>
        <th>Transaction ID</th>
        <th>Type</th>
        <th>Amount (₹)</th>
        <th>Recipient Account</th>
        <th>Date</th>
        <th>Status</th>
        <th>Report</th>
      </tr>
    </thead>
    <tbody>
      {% for tx in transactions %}
      <tr>
        <td>{{ "TNX" + tx.local_timestamp.strftime('%Y%m%d') + ("%04d"|format(tx.id)) }}</td>
        <td>{{ tx.type }}</td>
        <td>
          {% if tx.type.lower() in ['deposit', 'received'] %}
            <span class="text-success">+₹{{ "%.2f"|format(tx.amount) }}</span>
          {% else %}
            <span class="text-danger">-₹{{ "%.2f"|format(tx.amount) }}</span>
          {% endif %}
        </td>
        <td>{{ tx.recipient_account or '-' }}</td>
        <td>{{ tx.local_timestamp.strftime('%Y-%m-%d %I:%M %p') if tx.local_timestamp else 'N/A' }}</td>
        <td>
          {% if tx.status %}
            {% if tx.status.lower() == 'success' %}
              <span class="badge bg-success">{{ tx.status }}</span>
            {% elif tx.status.lower() == 'failed' %}
              <span class="badge bg-danger">{{ tx.status }}</span>
            {% else %}
              <span class="badge bg-secondary">{{ tx.status }}</span>
            {% endif %}
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td>
          {% if tx.id in reported_ids %}
            <span class="text-muted">Reported</span>
          {% else %}
            <form method="POST" action="{{ url_for('customer.report_transaction', transaction_id=tx.id) }}">
              <input type="text" name="reason" placeholder="Reason (optional)" class="form-control mb-1">
              <button type="submit" class="btn btn-danger btn-sm">Report</button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p class="text-muted">No transactions found.</p>
  {% endif %}

  <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary mt-4">Back to Dashboard</a>
</div>
{% endblock %}
